# GMR to LeRobot v2 Conversion for Unitree G1

This directory contains scripts to convert 29-DOF Unitree G1 joint trajectories from the GMR (General Motion Retargeting) pipeline into LeRobot v2 format, suitable for replay and training in Isaac-GR00T.

## Usage

### Installation

If you are on a **GPU machine**, install with the `gpu` extra to include performance-critical dependencies like `flash-attn` and `deepspeed`:

```bash
uv sync --extra gpu
```

On a **CPU-only machine**, a standard sync is sufficient for replay:

```bash
uv sync
```

Run the conversion script:

```bash
uv run scripts/lerobot_conversion/GMR.py \
    --input ../data/GMR/results.pkl \
    --output ../data/lerobot_GMR
```

## Joint Mapping Rationale

The conversion maps the flat 29-dimensional `dof_pos` vector from GMR into the structured modalities expected by the `UNITREE_G1` embodiment in Isaac-GR00T.

### Discovery Process
1. **Source Tracing**: Tracing `GMR/scripts/prompthmr_to_robot.py` confirmed that the output `results.pkl` contains a `dof_pos` array of shape `(N, 29)`. These represent the joint positions (`qpos[7:]`) after the 7-DOF root (pos + rot) is removed.
2. **Kinematics Model**: The GMR pipeline uses the MuJoCo model defined in `GMR/assets/unitree_g1/g1_mocap_29dof.xml`. 
3. **Joint Identification**: By examining the `<actuator>` and `<joint>` definitions in that XML, we identified the exact order of the 29 joints.
4. **Modality Grouping**: We grouped these joints into the named modalities required by the `UNITREE_G1` configuration in `Isaac-GR00T/gr00t/configs/data/embodiment_configs.py`.

### Mapping Table
The 29 indices are mapped as follows:

| Indices | Modality Key | Joint Names (from XML) |
|---------|--------------|------------------------|
| **0 - 5** | `left_leg` | hip_yaw, hip_roll, hip_pitch, knee, ankle_pitch, ankle_roll |
| **6 - 11** | `right_leg` | hip_yaw, hip_roll, hip_pitch, knee, ankle_pitch, ankle_roll |
| **12 - 14** | `waist` | waist_yaw, waist_roll, waist_pitch |
| **15 - 21** | `left_arm` | shoulder_pitch, shoulder_roll, shoulder_yaw, elbow, wrist_roll, wrist_pitch, wrist_yaw |
| **22 - 28** | `right_arm` | shoulder_pitch, shoulder_roll, shoulder_yaw, elbow, wrist_roll, wrist_pitch, wrist_yaw |

### Action Modalities
In addition to the state joints, the `UNITREE_G1` alignment requires action keys for hands and commands. Since GMR primary outputs joint positions:
- `left_hand` / `right_hand`: Defaulted to zero (2-dim) as these are not currently in the GMR 29-DOF output.
- `base_height_command` / `navigate_command`: Initialized with defaults to satisfy the Isaac-GR00T policy interface.

## Replay and Low-Level Control Generation

To produce **low-level motor controls** (joint positions, velocities, and torques), you need to connect the policy server to the **GR00T Whole Body Control (WBC)** component.

### 4-Loop Architecture

Open four separate terminal windows and run the following in order:

1. **Terminal 1: Policy Server** (Replays the dataset)
   ```bash
   uv run gr00t/eval/run_gr00t_server.py \
       --embodiment_tag UNITREE_G1 \
       --dataset-path ../data/lerobot_GMR \
       --use-sim-policy-wrapper \
       --device cuda  # Use 'cpu' if no GPU available
   ```

2. **Terminal 2: Sim Loop** (Physics Engine)
   ```bash
   uv run external_dependencies/GR00T-WholeBodyControl/gr00t_wbc/control/main/teleop/run_sim_loop.py \
       --simulator mujoco
   ```

3. **Terminal 3: Control Loop** (WBC Solver)
   ```bash
   uv run external_dependencies/GR00T-WholeBodyControl/gr00t_wbc/control/main/teleop/run_g1_control_loop.py \
       --simulator mujoco
   ```

4. **Terminal 4: Teleop Policy Loop** (Client Bridge)
   ```bash
   uv run external_dependencies/GR00T-WholeBodyControl/gr00t_wbc/control/main/teleop/run_teleop_policy_loop.py \
       --policy_client_host 127.0.0.1 \
       --policy_client_port 5555
   ```

### Capturing Low-Level Data
To save the optimized low-level commands into a new dataset, run a 5th terminal:
```bash
uv run external_dependencies/GR00T-WholeBodyControl/gr00t_wbc/control/main/teleop/run_g1_data_exporter.py
```
Press **'c'** to start/stop recording. The resulting dataset will contain the low-level joint targets generated by the WBC.